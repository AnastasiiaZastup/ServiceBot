<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <h1>–ü—Ä–∏–≤—ñ—Ç üëã</h1>
    <p>–¶–µ —Ç–≤—ñ–π Telegram Mini App!</p>

    <button onclick="testPing()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –±–µ–∫–µ–Ω–¥</button>
    <pre id="result"></pre>

    <button onclick="registerUser()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
    <pre id="registerResult"></pre>

    <script>
      const tg = window.Telegram.WebApp;
      tg.expand();

      console.log("tg.initDataUnsafe:", tg.initDataUnsafe);
      console.log("tg.initDataUnsafe.user:", tg.initDataUnsafe?.user);

      async function testPing() {
        try {
          const res = await fetch(
            "https://service-bot-backend.onrender.com/ping"
          );
          const data = await res.json();
          document.getElementById("result").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          console.error("–ü–æ–º–∏–ª–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É –¥–æ –±–µ–∫–µ–Ω–¥—É:", error);
        }
      }

      async function registerUser() {
        const tgUser = tg.initDataUnsafe?.user;

        if (!tgUser?.id) {
          console.warn("tgUser –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π –∞–±–æ –Ω–µ –º–∞—î ID:", tgUser);
          document.getElementById("registerResult").textContent =
            "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ Telegram ID";
          return;
        }

        const body = {
          telegram_id: tgUser.id,
          name: tgUser.first_name,
          username: tgUser.username || null,
          phone: null,
        };

        console.log("üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:", body);

        try {
          const res = await fetch(
            "https://service-bot-backend.onrender.com/user/register",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            }
          );

          const data = await res.json();
          console.log("‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –±–µ–∫–µ–Ω–¥—É:", data);

          document.getElementById("registerResult").textContent =
            JSON.stringify(data, null, 2);
        } catch (err) {
          console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:", err);
          document.getElementById("registerResult").textContent =
            "–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó";
        }
      }
    </script>
  </body>
</html>
